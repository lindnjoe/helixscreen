# helix_macros v2.0.0
# SPDX-License-Identifier: GPL-3.0-or-later
# Copyright 2025 HelixScreen Contributors
#
# HelixScreen Integration Macros
# ==============================
# Provides print phase detection, pre-print helpers, and optional progress tracking.
#
# INSTALLATION:
#   1. Copy this file to your Klipper config directory
#   2. Add to printer.cfg: [include helix_macros.cfg]
#   3. Add HELIX_READY to the END of your PRINT_START macro
#
# USAGE:
#   In your PRINT_START macro, add at the very end (after all prep is done):
#     HELIX_READY
#
#   For fine-grained phase tracking, optionally call these during PRINT_START:
#     HELIX_PHASE_HOMING
#     HELIX_PHASE_HEATING_BED
#     HELIX_PHASE_HEATING_NOZZLE
#     HELIX_PHASE_BED_MESH
#     HELIX_PHASE_QGL
#     HELIX_PHASE_Z_TILT
#     HELIX_PHASE_CLEANING
#     HELIX_PHASE_PURGING
#
# REMOVAL:
#   Remove the [include] line from printer.cfg

# ============================================================================
# State Container
# ============================================================================

[gcode_macro _HELIX_STATE]
description: HelixScreen state tracking (internal use)
variable_active: False
variable_phase: "IDLE"
gcode:
    # State container only - no G-code to execute

# ============================================================================
# Core Signals
# ============================================================================

[gcode_macro HELIX_READY]
description: Signal that print preparation is complete - ADD THIS TO END OF PRINT_START
gcode:
    SET_GCODE_VARIABLE MACRO=_HELIX_STATE VARIABLE=active VALUE=True
    SET_GCODE_VARIABLE MACRO=_HELIX_STATE VARIABLE=phase VALUE='"PRINTING"'
    RESPOND MSG="HELIX:READY"

[gcode_macro HELIX_ENDED]
description: Signal that print has ended
gcode:
    SET_GCODE_VARIABLE MACRO=_HELIX_STATE VARIABLE=active VALUE=False
    SET_GCODE_VARIABLE MACRO=_HELIX_STATE VARIABLE=phase VALUE='"IDLE"'
    RESPOND MSG="HELIX:ENDED"

[gcode_macro HELIX_RESET]
description: Reset HelixScreen state (for cancel/error recovery)
gcode:
    SET_GCODE_VARIABLE MACRO=_HELIX_STATE VARIABLE=active VALUE=False
    SET_GCODE_VARIABLE MACRO=_HELIX_STATE VARIABLE=phase VALUE='"IDLE"'

# ============================================================================
# Phase Tracking (Optional - for detailed progress display)
# ============================================================================

[gcode_macro HELIX_PHASE_HOMING]
description: Signal homing phase
gcode:
    SET_GCODE_VARIABLE MACRO=_HELIX_STATE VARIABLE=phase VALUE='"HOMING"'
    RESPOND MSG="HELIX:PHASE:HOMING"

[gcode_macro HELIX_PHASE_HEATING_BED]
description: Signal bed heating phase
gcode:
    SET_GCODE_VARIABLE MACRO=_HELIX_STATE VARIABLE=phase VALUE='"HEATING_BED"'
    RESPOND MSG="HELIX:PHASE:HEATING_BED"

[gcode_macro HELIX_PHASE_HEATING_NOZZLE]
description: Signal nozzle heating phase
gcode:
    SET_GCODE_VARIABLE MACRO=_HELIX_STATE VARIABLE=phase VALUE='"HEATING_NOZZLE"'
    RESPOND MSG="HELIX:PHASE:HEATING_NOZZLE"

[gcode_macro HELIX_PHASE_BED_MESH]
description: Signal bed mesh/leveling phase
gcode:
    SET_GCODE_VARIABLE MACRO=_HELIX_STATE VARIABLE=phase VALUE='"BED_MESH"'
    RESPOND MSG="HELIX:PHASE:BED_MESH"

[gcode_macro HELIX_PHASE_QGL]
description: Signal quad gantry level phase
gcode:
    SET_GCODE_VARIABLE MACRO=_HELIX_STATE VARIABLE=phase VALUE='"QGL"'
    RESPOND MSG="HELIX:PHASE:QGL"

[gcode_macro HELIX_PHASE_Z_TILT]
description: Signal Z tilt adjustment phase
gcode:
    SET_GCODE_VARIABLE MACRO=_HELIX_STATE VARIABLE=phase VALUE='"Z_TILT"'
    RESPOND MSG="HELIX:PHASE:Z_TILT"

[gcode_macro HELIX_PHASE_CLEANING]
description: Signal nozzle cleaning phase
gcode:
    SET_GCODE_VARIABLE MACRO=_HELIX_STATE VARIABLE=phase VALUE='"CLEANING"'
    RESPOND MSG="HELIX:PHASE:CLEANING"

[gcode_macro HELIX_PHASE_PURGING]
description: Signal purge/priming phase
gcode:
    SET_GCODE_VARIABLE MACRO=_HELIX_STATE VARIABLE=phase VALUE='"PURGING"'
    RESPOND MSG="HELIX:PHASE:PURGING"

# ============================================================================
# Pre-Print Helper Macros
# ============================================================================

[gcode_macro HELIX_BED_LEVEL_IF_NEEDED]
description: Perform bed mesh if stale or missing
variable_last_mesh_time: 0
gcode:
    {% set max_age = params.MAX_AGE|default(60)|int %}
    {% set current_time = printer.idle_timeout.printing_time %}
    {% set mesh_age = current_time - printer["gcode_macro HELIX_BED_LEVEL_IF_NEEDED"].last_mesh_time %}

    {% if printer.bed_mesh.profile_name == "" or mesh_age > (max_age * 60) %}
        { action_respond_info("HelixScreen: Mesh stale or missing, running BED_MESH_CALIBRATE") }
        BED_MESH_CALIBRATE
        SET_GCODE_VARIABLE MACRO=HELIX_BED_LEVEL_IF_NEEDED VARIABLE=last_mesh_time VALUE={current_time}
    {% else %}
        { action_respond_info("HelixScreen: Using existing mesh (age: %d min)" % (mesh_age / 60)) }
    {% endif %}

[gcode_macro HELIX_CLEAN_NOZZLE]
description: Clean nozzle before print
variable_brush_x: -1
variable_brush_y: -1
variable_brush_z: -1
variable_wipe_count: 5
variable_wipe_length: 40
gcode:
    {% set brush_x = printer["gcode_macro HELIX_CLEAN_NOZZLE"].brush_x %}
    {% set brush_y = printer["gcode_macro HELIX_CLEAN_NOZZLE"].brush_y %}
    {% set brush_z = printer["gcode_macro HELIX_CLEAN_NOZZLE"].brush_z %}
    {% set wipe_count = printer["gcode_macro HELIX_CLEAN_NOZZLE"].wipe_count %}
    {% set wipe_length = printer["gcode_macro HELIX_CLEAN_NOZZLE"].wipe_length %}

    SAVE_GCODE_STATE NAME=helix_clean_nozzle
    G90

    {% if brush_x >= 0 and brush_y >= 0 %}
        G0 X{brush_x} Y{brush_y} F6000
        {% if brush_z >= 0 %}
            G0 Z{brush_z} F1500
        {% endif %}
        {% for i in range(wipe_count) %}
            G0 X{brush_x + wipe_length} F6000
            G0 X{brush_x} F6000
        {% endfor %}
        { action_respond_info("HelixScreen: Nozzle cleaning complete") }
    {% else %}
        G91
        G1 E-2 F300
        G90
        { action_respond_info("HelixScreen: No brush configured, performed small retract") }
    {% endif %}

    RESTORE_GCODE_STATE NAME=helix_clean_nozzle

[gcode_macro HELIX_START_PRINT]
description: Unified start print with pre-print options (uses PERFORM_* opt-in parameters)
gcode:
    {% set bed_temp = params.BED_TEMP|default(60)|int %}
    {% set extruder_temp = params.EXTRUDER_TEMP|default(200)|int %}
    # PERFORM_* parameters: 1=do operation, 0 or omitted=skip (opt-in semantics)
    {% set perform_qgl = params.PERFORM_QGL|default(0)|int %}
    {% set perform_z_tilt = params.PERFORM_Z_TILT|default(0)|int %}
    {% set perform_bed_mesh = params.PERFORM_BED_MESH|default(0)|int %}
    {% set perform_nozzle_clean = params.PERFORM_NOZZLE_CLEAN|default(0)|int %}

    { action_respond_info("HelixScreen: Starting pre-print sequence") }

    M140 S{bed_temp}

    {% if "xyz" not in printer.toolhead.homed_axes %}
        { action_respond_info("HelixScreen: Homing...") }
        HELIX_PHASE_HOMING
        G28
    {% endif %}

    {% if perform_qgl == 1 %}
        {% if printer.configfile.settings.quad_gantry_level is defined %}
            { action_respond_info("HelixScreen: Running Quad Gantry Level...") }
            HELIX_PHASE_QGL
            QUAD_GANTRY_LEVEL
        {% endif %}
    {% endif %}

    {% if perform_z_tilt == 1 %}
        {% if printer.configfile.settings.z_tilt is defined %}
            { action_respond_info("HelixScreen: Running Z-Tilt Adjust...") }
            HELIX_PHASE_Z_TILT
            Z_TILT_ADJUST
        {% endif %}
    {% endif %}

    {% if perform_bed_mesh == 1 %}
        { action_respond_info("HelixScreen: Running Bed Mesh Calibrate...") }
        HELIX_PHASE_BED_MESH
        BED_MESH_CALIBRATE
    {% endif %}

    HELIX_PHASE_HEATING_BED
    M190 S{bed_temp}

    HELIX_PHASE_HEATING_NOZZLE
    M109 S{extruder_temp}

    {% if perform_nozzle_clean == 1 %}
        HELIX_PHASE_CLEANING
        HELIX_CLEAN_NOZZLE
    {% endif %}

    { action_respond_info("HelixScreen: Pre-print sequence complete") }
    HELIX_READY
