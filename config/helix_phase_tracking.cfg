# SPDX-License-Identifier: GPL-3.0-or-later
# Copyright 2025 HelixScreen Contributors
#
# HelixScreen Phase Tracking Macros
# =================================
# Optional macro package for fine-grained print preparation tracking.
#
# INSTALLATION:
#   1. Copy this file to your Klipper config directory
#   2. Add to printer.cfg: [include helix_phase_tracking.cfg]
#   3. Add HELIX_PRINT_COMPLETE to the END of your PRINT_START macro
#
# USAGE:
#   In your PRINT_START macro, add at the very end (after all prep is done):
#     HELIX_PRINT_COMPLETE
#
#   For fine-grained phase tracking, you can optionally call these anywhere
#   in your PRINT_START macro:
#     HELIX_PHASE_HOMING
#     HELIX_PHASE_HEATING_BED
#     HELIX_PHASE_HEATING_NOZZLE
#     HELIX_PHASE_BED_MESH
#     HELIX_PHASE_QGL
#     HELIX_PHASE_Z_TILT
#     HELIX_PHASE_CLEANING
#     HELIX_PHASE_PURGING
#
# REMOVAL:
#   Remove the [include] line from printer.cfg
#

# ============================================================================
# State Variable Container
# ============================================================================

[gcode_macro _HELIX_PHASE_STATE]
description: Internal state container for HelixScreen phase tracking
variable_active: False
gcode:
    # This macro just holds state - no action needed

# ============================================================================
# Main Phase Signals
# ============================================================================

[gcode_macro HELIX_PRINT_STARTING]
description: Signal that PRINT_START macro is beginning (usually called by plugin)
gcode:
    SET_GCODE_VARIABLE MACRO=_HELIX_PHASE_STATE VARIABLE=active VALUE=True
    RESPOND MSG="HELIX:PHASE:STARTING"

[gcode_macro HELIX_PRINT_COMPLETE]
description: Signal that PRINT_START macro has completed - ADD THIS TO END OF YOUR PRINT_START
gcode:
    {% if printer["gcode_macro _HELIX_PHASE_STATE"].active %}
        RESPOND MSG="HELIX:PHASE:COMPLETE"
        SET_GCODE_VARIABLE MACRO=_HELIX_PHASE_STATE VARIABLE=active VALUE=False
    {% endif %}

# ============================================================================
# Individual Phase Signals (Optional - for detailed progress tracking)
# ============================================================================

[gcode_macro HELIX_PHASE_HOMING]
description: Signal homing phase
gcode:
    {% if printer["gcode_macro _HELIX_PHASE_STATE"].active %}
        RESPOND MSG="HELIX:PHASE:HOMING"
    {% endif %}

[gcode_macro HELIX_PHASE_HEATING_BED]
description: Signal bed heating phase
gcode:
    {% if printer["gcode_macro _HELIX_PHASE_STATE"].active %}
        RESPOND MSG="HELIX:PHASE:HEATING_BED"
    {% endif %}

[gcode_macro HELIX_PHASE_HEATING_NOZZLE]
description: Signal nozzle heating phase
gcode:
    {% if printer["gcode_macro _HELIX_PHASE_STATE"].active %}
        RESPOND MSG="HELIX:PHASE:HEATING_NOZZLE"
    {% endif %}

[gcode_macro HELIX_PHASE_BED_MESH]
description: Signal bed mesh/leveling phase
gcode:
    {% if printer["gcode_macro _HELIX_PHASE_STATE"].active %}
        RESPOND MSG="HELIX:PHASE:BED_MESH"
    {% endif %}

[gcode_macro HELIX_PHASE_QGL]
description: Signal quad gantry level phase
gcode:
    {% if printer["gcode_macro _HELIX_PHASE_STATE"].active %}
        RESPOND MSG="HELIX:PHASE:QGL"
    {% endif %}

[gcode_macro HELIX_PHASE_Z_TILT]
description: Signal Z tilt adjustment phase
gcode:
    {% if printer["gcode_macro _HELIX_PHASE_STATE"].active %}
        RESPOND MSG="HELIX:PHASE:Z_TILT"
    {% endif %}

[gcode_macro HELIX_PHASE_CLEANING]
description: Signal nozzle cleaning phase
gcode:
    {% if printer["gcode_macro _HELIX_PHASE_STATE"].active %}
        RESPOND MSG="HELIX:PHASE:CLEANING"
    {% endif %}

[gcode_macro HELIX_PHASE_PURGING]
description: Signal purge/priming phase
gcode:
    {% if printer["gcode_macro _HELIX_PHASE_STATE"].active %}
        RESPOND MSG="HELIX:PHASE:PURGING"
    {% endif %}
