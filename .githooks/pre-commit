#!/bin/bash
# SPDX-License-Identifier: GPL-3.0-or-later
# Git pre-commit hook for HelixScreen
#
# This hook runs quality checks (including clang-format) before each commit.
# Files with formatting issues are auto-fixed and staged.
#
# Setup (one-time):
#   git config core.hooksPath .githooks
#
# Bypass for one commit:
#   git commit --no-verify

set -e

echo "ðŸ” Running pre-commit quality checks..."
echo ""

# Get list of staged C/C++ files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACMR | grep -E '\.(cpp|c|h|hpp)$' || true)

if [ -z "$STAGED_FILES" ]; then
    echo "âœ… No C/C++ files staged - skipping format check"
    exit 0
fi

# Check if clang-format is available
if ! command -v clang-format &> /dev/null; then
    echo "âš ï¸  clang-format not found - skipping format check"
    exit 0
fi

# Check formatting and auto-fix
NEEDS_FORMAT=()
for file in $STAGED_FILES; do
    if [ -f "$file" ]; then
        # Check if file needs formatting
        if ! clang-format --dry-run --Werror "$file" &> /dev/null; then
            NEEDS_FORMAT+=("$file")
        fi
    fi
done

if [ ${#NEEDS_FORMAT[@]} -gt 0 ]; then
    echo "ðŸŽ¨ Auto-formatting ${#NEEDS_FORMAT[@]} file(s)..."
    for file in "${NEEDS_FORMAT[@]}"; do
        clang-format -i "$file"
        git add "$file"
        echo "   âœ“ $file"
    done
    echo ""
    echo "âœ… Files formatted and re-staged"
fi

echo "âœ… Pre-commit checks passed"
exit 0
